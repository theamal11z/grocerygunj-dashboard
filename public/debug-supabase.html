<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Debug Tool</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .panel {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    button {
      background: #4f46e5;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:hover {
      background: #4338ca;
    }
    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    input {
      padding: 8px;
      margin-right: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 250px;
    }
  </style>
</head>
<body>
  <h1>Supabase Debug Tool</h1>
  
  <div class="panel">
    <h2>Connection</h2>
    <div>
      <input type="text" id="supabase-url" placeholder="Supabase URL" value="https://hgddybhgcawokycncvgn.supabase.co">
      <input type="text" id="anon-key" placeholder="Anon Key" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnZGR5YmhnY2F3b2t5Y25jdmduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3MDgwMDMsImV4cCI6MjA1NzI4NDAwM30.Ko6MkWyjM1BqBeQ6_uDRh-miW8KFHPWAMuIxFqj5sOY">
      <button id="initialize">Initialize Client</button>
    </div>
  </div>

  <div class="panel">
    <h2>Authentication</h2>
    <div>
      <input type="email" id="email" placeholder="Email" value="admin@example.com">
      <input type="password" id="password" placeholder="Password" value="password123">
      <button id="sign-in">Sign In</button>
      <button id="sign-out">Sign Out</button>
      <button id="get-session">Get Session</button>
    </div>
  </div>

  <div class="panel">
    <h2>Data Access</h2>
    <div>
      <button id="fetch-products">Fetch Products</button>
      <button id="fetch-categories">Fetch Categories</button>
      <button id="fetch-orders">Fetch Orders</button>
      <button id="fetch-offers">Fetch Offers</button>
    </div>
  </div>

  <div class="panel">
    <h2>Log</h2>
    <pre id="log"></pre>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    
    // Log function for displaying results
    function log(message, type = 'info') {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const formattedMessage = typeof message === 'object' ? JSON.stringify(message, null, 2) : message;
      
      logElement.innerHTML += `[${timestamp}] [${type}] ${formattedMessage}\n`;
      logElement.scrollTop = logElement.scrollHeight;
      
      console[type](message);
    }
    
    // Clear log
    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }
    
    // Supabase client
    let supabase = null;
    
    // Initialize client
    document.getElementById('initialize').addEventListener('click', () => {
      const url = document.getElementById('supabase-url').value;
      const key = document.getElementById('anon-key').value;
      
      if (!url || !key) {
        log('URL and key are required', 'error');
        return;
      }
      
      try {
        clearLog();
        log(`Initializing Supabase client with:\nURL: ${url}\nKey: ${key.substring(0, 10)}...`);
        
        supabase = createClient(url, key, {
          auth: {
            autoRefreshToken: true,
            persistSession: true,
            storageKey: 'debug-tool-auth'
          }
        });
        
        log('Supabase client initialized successfully');
      } catch (error) {
        log(`Error initializing client: ${error.message}`, 'error');
      }
    });
    
    // Sign in
    document.getElementById('sign-in').addEventListener('click', async () => {
      if (!supabase) {
        log('Initialize the client first', 'error');
        return;
      }
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        log('Email and password are required', 'error');
        return;
      }
      
      try {
        log(`Attempting to sign in with email: ${email}`);
        
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });
        
        if (error) {
          log(`Sign in error: ${error.message}`, 'error');
          return;
        }
        
        log('Sign in successful');
        log(data);
        
        // Check if user has admin role
        try {
          const { data: profileData, error: profileError } = await supabase
            .from('profiles')
            .select('role')
            .eq('id', data.user.id)
            .single();
            
          if (profileError) {
            log(`Error fetching profile: ${profileError.message}`, 'error');
            return;
          }
          
          log(`User profile: ${JSON.stringify(profileData)}`);
          
          if (profileData?.role === 'admin') {
            log('User has admin role');
          } else {
            log('User does not have admin role', 'warn');
            
            // In development, try to update role to admin
            try {
              const { error: updateError } = await supabase
                .from('profiles')
                .update({ role: 'admin' })
                .eq('id', data.user.id);
                
              if (updateError) {
                log(`Error updating role: ${updateError.message}`, 'error');
              } else {
                log('Updated user role to admin');
              }
            } catch (err) {
              log(`Error updating role: ${err.message}`, 'error');
            }
          }
        } catch (err) {
          log(`Error checking admin status: ${err.message}`, 'error');
        }
      } catch (error) {
        log(`Error during sign in: ${error.message}`, 'error');
      }
    });
    
    // Sign out
    document.getElementById('sign-out').addEventListener('click', async () => {
      if (!supabase) {
        log('Initialize the client first', 'error');
        return;
      }
      
      try {
        const { error } = await supabase.auth.signOut();
        
        if (error) {
          log(`Sign out error: ${error.message}`, 'error');
          return;
        }
        
        log('Signed out successfully');
      } catch (error) {
        log(`Error during sign out: ${error.message}`, 'error');
      }
    });
    
    // Get session
    document.getElementById('get-session').addEventListener('click', async () => {
      if (!supabase) {
        log('Initialize the client first', 'error');
        return;
      }
      
      try {
        const { data, error } = await supabase.auth.getSession();
        
        if (error) {
          log(`Error getting session: ${error.message}`, 'error');
          return;
        }
        
        if (data.session) {
          log('Active session found:');
          log(data.session);
        } else {
          log('No active session');
        }
      } catch (error) {
        log(`Error getting session: ${error.message}`, 'error');
      }
    });
    
    // Fetch products
    document.getElementById('fetch-products').addEventListener('click', async () => {
      if (!supabase) {
        log('Initialize the client first', 'error');
        return;
      }
      
      try {
        log('Fetching products...');
        
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .limit(5);
        
        if (error) {
          log(`Error fetching products: ${error.message}`, 'error');
          return;
        }
        
        log(`Fetched ${data.length} products:`);
        log(data);
      } catch (error) {
        log(`Error fetching products: ${error.message}`, 'error');
      }
    });
    
    // Fetch categories
    document.getElementById('fetch-categories').addEventListener('click', async () => {
      if (!supabase) {
        log('Initialize the client first', 'error');
        return;
      }
      
      try {
        log('Fetching categories...');
        
        const { data, error } = await supabase
          .from('categories')
          .select('*');
        
        if (error) {
          log(`Error fetching categories: ${error.message}`, 'error');
          return;
        }
        
        log(`Fetched ${data.length} categories:`);
        log(data);
      } catch (error) {
        log(`Error fetching categories: ${error.message}`, 'error');
      }
    });
    
    // Fetch orders
    document.getElementById('fetch-orders').addEventListener('click', async () => {
      if (!supabase) {
        log('Initialize the client first', 'error');
        return;
      }
      
      try {
        log('Fetching orders...');
        
        const { data, error } = await supabase
          .from('orders')
          .select('*')
          .limit(5);
        
        if (error) {
          log(`Error fetching orders: ${error.message}`, 'error');
          return;
        }
        
        log(`Fetched ${data.length} orders:`);
        log(data);
      } catch (error) {
        log(`Error fetching orders: ${error.message}`, 'error');
      }
    });
    
    // Fetch offers
    document.getElementById('fetch-offers').addEventListener('click', async () => {
      if (!supabase) {
        log('Initialize the client first', 'error');
        return;
      }
      
      try {
        log('Fetching offers...');
        
        const { data, error } = await supabase
          .from('offers')
          .select('*');
        
        if (error) {
          log(`Error fetching offers: ${error.message}`, 'error');
          return;
        }
        
        log(`Fetched ${data.length} offers:`);
        log(data);
      } catch (error) {
        log(`Error fetching offers: ${error.message}`, 'error');
      }
    });
    
    // Auto-initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('initialize').click();
    });
  </script>
</body>
</html> 